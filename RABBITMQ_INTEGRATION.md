# üê∞ RabbitMQ Integration - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üìã –û–±–∑–æ—Ä

LMS –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å **Central Auth Service** —á–µ—Ä–µ–∑ RabbitMQ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ö–æ–≥–¥–∞ –≤ Central Auth –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, LMS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–∏ —Å–æ–±—ã—Ç–∏—è.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Central Auth       ‚îÇ
‚îÇ  Service            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ Publish Events
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     RabbitMQ        ‚îÇ
‚îÇ  Exchange:          ‚îÇ
‚îÇ  user_events        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ Subscribe
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   LMS Backend       ‚îÇ
‚îÇ   (Consumer)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üì° –°–æ–±—ã—Ç–∏—è

LMS –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è:

### 1. `user.created` - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**–î–µ–π—Å—Ç–≤–∏–µ:** –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ LMS (–µ—Å–ª–∏ —É –Ω–µ–≥–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ LMS)

**–ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è:**
```json
{
  "event_type": "user.created",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "user": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "student@example.com",
    "first_name": "–ò–≤–∞–Ω",
    "last_name": "–ò–≤–∞–Ω–æ–≤",
    "password_hash": "$2b$12$...",
    "role": "student",
    "is_active": true,
    "allowed_services_json": "[\"lms\", \"sat\"]"
  },
  "timestamp": "2024-01-01T12:00:00Z"
}
```

**–õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ LMS (–¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ - —á–µ—Ä–µ–∑ `allowed_services_json`)
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ LMS –µ—Å–ª–∏:
  - –†–æ–ª—å != "student" (—É—á–∏—Ç–µ–ª—è, –∫—É—Ä–∞—Ç–æ—Ä—ã, –∞–¥–º–∏–Ω—ã –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º—É)
  - –ò–õ–ò "lms" –µ—Å—Ç—å –≤ `allowed_services_json`
- ‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ LMS

### 2. `user.updated` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**–î–µ–π—Å—Ç–≤–∏–µ:** –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ LMS

**–õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç: –∏–º—è, —Ä–æ–ª—å, —Å—Ç–∞—Ç—É—Å, –ø–∞—Ä–æ–ª—å
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ LMS:
  - –ï—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –ë–ï–ó –¥–æ—Å—Ç—É–ø–∞ –∫ LMS ‚Üí –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç (`is_active = false`)
  - –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª

### 3. `user.deleted` - –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**–î–µ–π—Å—Ç–≤–∏–µ:** –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ LMS

**–õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
- ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `is_active = false`
- ‚ÑπÔ∏è –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ù–ï —É–¥–∞–ª—è—é—Ç—Å—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏ (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏)

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Environment Variables (.env)

```bash
# RabbitMQ Configuration
RABBITMQ_URL=amqp://guest:guest@localhost:5672/
RABBITMQ_EXCHANGE=user_events
```

### Production (Docker Compose)

–ï—Å–ª–∏ RabbitMQ –≤ Docker Compose:
```bash
RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
```

## üöÄ –ó–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pip install -r requirements.txt
```

2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env —Ñ–∞–π–ª:
```bash
cp .env.example .env
# –î–æ–±–∞–≤–∏—Ç—å RABBITMQ_URL
```

3. –ó–∞–ø—É—Å—Ç–∏—Ç—å RabbitMQ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω):
```bash
docker run -d --name rabbitmq \
  -p 5672:5672 \
  -p 15672:15672 \
  rabbitmq:3-management
```

4. –ó–∞–ø—É—Å—Ç–∏—Ç—å LMS backend:
```bash
uvicorn src.app:app --reload
```

Consumer –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ! üéâ

### Docker Compose

Consumer –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
```bash
docker-compose up -d
```

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

Consumer –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Å —ç–º–æ–¥–∑–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞:

```
‚úÖ Connected to RabbitMQ: user_events
üì• Listening for events: user.created, user.updated, user.deleted
üì® Received event: user.created for user: student@example.com
‚úÖ User created in LMS: student@example.com (ID: 123)
‚è≠Ô∏è  Skipping user test@example.com - no LMS access
üîí User deactivated (no LMS access): oldstudent@example.com
üóëÔ∏è  User deactivated in LMS: deleted@example.com
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ RabbitMQ

–í –ª–æ–≥–∞—Ö LMS –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
‚úÖ Connected to RabbitMQ: user_events
üßµ RabbitMQ consumer thread started
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RabbitMQ Management UI

–û—Ç–∫—Ä—ã—Ç—å http://localhost:15672 (guest:guest)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å exchange `user_events`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–µ—Ä–µ–¥—å `lms_user_events`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å binding –∫ routing keys

### 3. –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ

–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Central Auth –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ LMS:
```bash
# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
üì® Received event: user.created for user: newuser@example.com
‚úÖ User created in LMS: newuser@example.com (ID: 456)
```

## üõ†Ô∏è –û—Ç–ª–∞–¥–∫–∞

### Consumer –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo $RABBITMQ_URL

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å RabbitMQ
telnet localhost 5672

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -f logs/app.log
```

### –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

```bash
# –í RabbitMQ Management UI –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
# 1. –ï—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏ lms_user_events
# 2. –ï—Å—Ç—å –ª–∏ consumers —É –æ—á–µ—Ä–µ–¥–∏
# 3. –°—Ç–∞—Ç—É—Å binding'–æ–≤

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –æ—à–∏–±–æ–∫
grep "‚ùå" logs/app.log
```

## üîÑ –õ–æ–≥–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ LMS

### –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (role = "student")

```python
allowed_services = ["lms", "sat"]  # –ò–∑ allowed_services_json

if "lms" in allowed_services:
    # ‚úÖ –°–æ–∑–¥–∞—Ç—å/–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ LMS
else:
    # ‚ùå –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
```

### –î–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π, –∫—É—Ä–∞—Ç–æ—Ä–æ–≤, –∞–¥–º–∏–Ω–æ–≤

```python
if role in ["teacher", "curator", "admin"]:
    # ‚úÖ –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤ LMS (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø)
```

## üìù –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π

| Central Auth | LMS | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|-------------|-----|-----------|
| `id` (UUID) | `student_id` | –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è —Å–≤—è–∑–∏ |
| `email` | `email` | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| `first_name + last_name` | `name` | –û–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è |
| `password_hash` | `hashed_password` | –£–∂–µ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω |
| `role` | `role` | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| `is_active` | `is_active` | –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–æ–º |
| `allowed_services_json` | - | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ |

## üö® –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ü–∞—Ä–æ–ª–∏ —É–∂–µ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã** - Central Auth –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ—Ç–æ–≤—ã–π hash
2. **–ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è, –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è
3. **–ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ** - –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ update, –æ–Ω —Å–æ–∑–¥–∞–µ—Ç—Å—è
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞** - —Å—Ç—É–¥–µ–Ω—Ç—ã –±–µ–∑ LMS –≤ permissions –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è
5. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–∞
6. **–§–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫** - consumer —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ daemon –ø–æ—Ç–æ–∫–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç API

## üîÆ Roadmap

- [ ] –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è failed messages
- [ ] Dead Letter Queue –¥–ª—è –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ Prometheus –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [ ] Health check endpoint –¥–ª—è consumer status
- [ ] Batch processing –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

## ü§ù –°–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å:
- SAT Service (–ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–µ –∂–µ —Å–æ–±—ã—Ç–∏—è)
- IELTS Service
- Support Service

–ü—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å –∏ subscribe –Ω–∞ –Ω—É–∂–Ω—ã–µ routing keys! üéØ
