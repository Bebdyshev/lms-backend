name: Deploy Backend to Azure VM

on:
  push:
    branches: [ main ]
    # –µ—Å–ª–∏ —Ä–µ–ø–æ —á–∏—Å—Ç–æ backend, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å paths –∏–ª–∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å '**'
    paths:
      - '**'

concurrency:
  group: deploy-backend
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to Azure VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.AZURE_HOST }}
        username: ${{ secrets.AZURE_USERNAME }}
        key: ${{ secrets.AZURE_SSH_KEY }}
        script: |
          set -e
          echo "üöÄ Starting backend deployment..."
          cd ~/lms-master
          git fetch origin main
          git reset --hard origin/main
          docker compose pull || true
          docker compose build
          docker compose up -d
          echo "‚úÖ Backend deployment completed!"

    - name: Health Check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.AZURE_HOST }}
        username: ${{ secrets.AZURE_USERNAME }}
        key: ${{ secrets.AZURE_SSH_KEY }}
        script: |
          set -e
          echo "üè• Performing health check..."
          cd ~/lms-master
          for i in {1..10}; do
            if curl -fsS http://localhost:8000/health >/dev/null 2>&1; then
              echo "‚úÖ Health check passed"
              exit 0
            fi
            echo "‚è≥ Waiting for backend to be healthy ($i/10)..."
            sleep 5
          done
          echo "‚ùå Health check failed, dumping logs:"
          docker compose logs --tail=200 backend || true
          exit 1